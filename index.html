<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é¾ã‚±å´å¸‚ é£²é£Ÿåº—ãƒãƒƒãƒ—</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --card-bg: #fff;
  --accent: #0078ff;
  --muted: #666;
}
body {
  margin: 0;
  font-family: "Noto Sans JP", system-ui, sans-serif;
  background: #f2f4f7;
}
#map {
  height: 100vh;
  width: 100%;
}
header.appbar {
  position: absolute;
  left: 10px;
  right: 10px;
  top: 10px;
  z-index: 1000;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
  padding: 10px;
  border-radius: 10px;
  background: var(--card-bg);
  box-shadow: 0 6px 20px rgba(8, 22, 48, 0.12);
}
header h1 {
  margin: 0;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.controls {
  display: flex;
  gap: 8px;
  align-items: center;
}
input[type="text"], select {
  padding: 8px 10px;
  border-radius: 8px;
  border: 1px solid #ddd;
  font-size: 14px;
}
button#locateBtn {
  background: var(--accent);
  color: #fff;
  border: none;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
}
button#locateBtn:active {
  transform: translateY(1px);
}
.popup-img {
  width: 240px;
  height: 140px;
  object-fit: cover;
  border-radius: 8px;
  display: block;
  margin: 0 auto 6px;
}
@media(max-width:600px) {
  header.appbar {
    left: 8px; right: 8px; top: 8px; padding: 8px;
  }
  .popup-img { width: 180px; height: 110px; }
  input[type="text"], select { width: 100%; }
  .controls { flex-direction: column; align-items: stretch; gap: 6px; width: 100%; }
}
.marker-div {
  width: 28px; height: 28px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  color: #fff; font-size: 14px; border: 2px solid #fff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.25);
}
.star-badge {
  position: relative;
  left: 8px; top: -8px;
  display: inline-block;
  background: rgba(255,212,59,0.95);
  padding: 2px 4px;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 700;
}
</style>
</head>

<body>
<header class="appbar">
  <div class="top-row" style="gap:12px; align-items:center;">
    <h1>ğŸœ é¾ã‚±å´å¸‚ é£²é£Ÿåº—ãƒãƒƒãƒ—ï¼ˆå®Œå…¨ç‰ˆï¼‰</h1>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="locateBtn">ğŸ“ ç¾åœ¨åœ°</button>
    </div>
  </div>
  <div class="controls" style="margin-top:6px; width:100%;">
    <select id="categoryFilter">
      <option value="all">ã™ã¹ã¦</option>
      <option value="favorite">â­ï¸ ãŠæ°—ã«å…¥ã‚Š</option> <option value="ãƒ©ãƒ¼ãƒ¡ãƒ³">ãƒ©ãƒ¼ãƒ¡ãƒ³</option>
      <option value="ã‚«ãƒ•ã‚§">ã‚«ãƒ•ã‚§</option>
      <option value="å¯¿å¸">å¯¿å¸</option>
      <option value="ç„¼è‚‰">ç„¼è‚‰</option>
      <option value="ä¸­è¯">ä¸­è¯</option>
      <option value="å±…é…’å±‹">å±…é…’å±‹</option>
      <option value="ã‚¹ã‚¤ãƒ¼ãƒ„">ã‚¹ã‚¤ãƒ¼ãƒ„</option>
      <option value="ãã®ä»–">ãã®ä»–</option>
    </select>
    <input type="text" id="searchBox" placeholder="åº—åã§æ¤œç´¢ï¼ˆä¾‹ï¼šãƒ©ãƒ¼ãƒ¡ãƒ³ï¼‰">
  </div>
</header>

<div id="map"></div>

<script>
// ====== ã‚«ãƒ†ã‚´ãƒªè‰² ======
function categoryColor(cat){
  switch(cat){
    case "ãƒ©ãƒ¼ãƒ¡ãƒ³": return "#e63946";
    case "ã‚«ãƒ•ã‚§": return "#2a9d8f";
    case "å¯¿å¸": return "#0077b6";
    case "ç„¼è‚‰": return "#d6336c";
    case "ä¸­è¯": return "#f4a261";
    case "å±…é…’å±‹": return "#6f42c1";
    case "ã‚¹ã‚¤ãƒ¼ãƒ„": return "#e76f51";
    default: return "#4a5568"; // ãã®ä»–
  }
}

// ====== åº—èˆ—ãƒ‡ãƒ¼ã‚¿ (idã‚’æ°¸ç¶šåŒ–ã‚­ãƒ¼ã¨ã—ã¦è¿½åŠ ) ======
const initialPlaces = [
  { id: 2, name: "å±±æ°´é–£", cat: "ã‚¦ãƒŠã‚®ã€ã—ã‚ƒã¶ã—ã‚ƒã¶", lat: 35.949219, lng: 140.1366538, img: "https://b081800.gorp.jp/", info: "äºˆç´„å¯ã€11:00 - 14:00ã€€17:00 - 20:00" },
  { id: 3, name: "ã‚¿ã‚¤ã‚¬ãƒ¼ãƒ‘ãƒ³ãƒ", cat: "ãã°", lat: 35.9129595, lng: 140.1904063, img: "https://x.com/tigerpunch_2024", info: "ç«æ›œå®šä¼‘æ—¥ã€ã‚«ãƒ¼ãƒ‰ãƒ»é›»å­ãƒãƒãƒ¼ãƒ»QRã‚³ãƒ¼ãƒ‰ä¸å¯" },
  { id: 4, name: "æ± ç”°å±‹", cat: "ãã°ã€ã†ã©ã‚“", lat: 35.9082809, lng: 140.1746611, img: "https://tblg.k-img.com/restaurant/images/Rvw/133058/150x150_square_133058348.jpg", info: "1000å††å‰å¾Œã€å®šä¼‘æ—¥ï¼šæ°´æ›œæ—¥ã€ç¾é‡‘ã®ã¿ã€äºˆç´„å¯" },
  { id: 5, name: "ç„¼è‚‰ã€€å¹¸å±‹", cat: "ç„¼è‚‰", lat: 35.9329486, lng: 140.1357874, img: "https://www.facebook.com/nikuyashikii/", info: "3000å††ï½5000å††ã€å®šä¼‘æ—¥ï¼šæœˆæ›œæ—¥ã€ã‚«ãƒ¼ãƒ‰ä¸å¯ã€äºˆç´„å¯" },
  { id: 6, name: "æ‰‹æ‰“ã¡ãã°è–¬å¸«å¯º", cat: "ãã°", lat: 35.9075281, lng: 140.1812618, img: "", info: "å®šä¼‘æ—¥ï¼šæ—¥æ›œæ—¥ã€ç¾é‡‘ã®ã¿ã€äºˆç´„ä¸å¯" },
  { id: 7, name: "æ¸…å…­å±‹", cat: "ãƒ©ãƒ¼ãƒ¡ãƒ³", lat: 35.9116106, lng: 140.1823263, img: "https://www.seirock-ya.jp/", info: "11:00~23:30ã€äºˆç´„ä¸å¯" },
  { id: 8, name: "ã¯ã¾å¯¿å¸", cat: "ãã®ä»–", lat: 35.9110378, lng: 140.180523, img: "https://www.hama-sushi.co.jp/", info: "æœˆï½é‡‘ 11:00ï½24:00ã€€åœŸæ—¥ç¥ 10:00ï½24:00ã€äºˆç´„å¯" },
  { id: 9, name: "éººã‚„ã€€ã“ã‚‚ã‚“", cat: "ãƒ©ãƒ¼ãƒ¡ãƒ³", lat: 35.9116106, lng: 140.1823263, img: "https://ameblo.jp/komon0928", info: "11:00~14:00  17:00~20:30ã€äºˆç´„ä¸å¯" }
];

// **ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã®æ°¸ç¶šåŒ–ãƒ­ã‚¸ãƒƒã‚¯**
const FAVORITES_STORAGE_KEY = 'ryugasaki_favorites';

function loadFavorites() {
    try {
        const favs = localStorage.getItem(FAVORITES_STORAGE_KEY);
        return favs ? JSON.parse(favs) : {};
    } catch (e) {
        console.error("Failed to load favorites from localStorage:", e);
        return {};
    }
}

function saveFavorites(favs) {
    try {
        localStorage.setItem(FAVORITES_STORAGE_KEY, JSON.stringify(favs));
    } catch (e) {
        console.error("Failed to save favorites to localStorage:", e);
    }
}

let favorites = loadFavorites();

// **åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã®æœ€çµ‚æ§‹ç¯‰**
const places = initialPlaces.map(p => ({
    ...p,
    isFavorite: !!favorites[p.id],
    getDisplayCategory: function() {
        const categories = this.cat.split('ã€').map(c => c.trim());
        const cat = categories.length > 0 ? categories[0] : 'ãã®ä»–';
        // ã‚«ãƒ†ã‚´ãƒªåãŒå­˜åœ¨ã™ã‚‹ãªã‚‰ãã‚Œã‚’ã€ãã†ã§ãªã‘ã‚Œã°ã€Œãã®ä»–ã€ã‚’è¿”ã™
        return categoryColor(cat) !== categoryColor('ãã®ä»–') ? cat : 'ãã®ä»–';
    }
}));


// ====== åœ°å›³åˆæœŸåŒ– ======
const map = L.map('map').setView([35.9, 140.18], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

// ====== ãƒãƒ¼ã‚«ãƒ¼ç”Ÿæˆ ======
function makeDivIcon(cat){
  const color = categoryColor(cat);
  const emoji = (cat==="ãƒ©ãƒ¼ãƒ¡ãƒ³"?"ğŸœ":cat==="ã‚«ãƒ•ã‚§"?"â˜•":cat==="å¯¿å¸"?"ğŸ£":cat==="ç„¼è‚‰"?"ğŸ¥©":cat==="ä¸­è¯"?"ğŸ¥¡":cat==="å±…é…’å±‹"?"ğŸ¶":cat==="ã‚¹ã‚¤ãƒ¼ãƒ„"?"ğŸ°":"ğŸ½ï¸");
  const html = `<div class="marker-div" style="background:${color}">${emoji}</div>`;
  return L.divIcon({ html, className:'custom-div-icon', iconSize:[34,34], iconAnchor:[17,34], popupAnchor:[0,-36] });
}

let markerObjs = [];

// **ãŠæ°—ã«å…¥ã‚ŠçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹**
function toggleFavorite(id) {
    const place = places.find(p => p.id === id);
    if (place) {
        place.isFavorite = !place.isFavorite;

        // æ°¸ç¶šåŒ–ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        if (place.isFavorite) {
            favorites[id] = true;
        } else {
            delete favorites[id];
        }
        saveFavorites(favorites);

        // ãƒãƒ¼ã‚«ãƒ¼å†æç”»
        const filterValue = document.getElementById('categoryFilter').value;
        const keywordValue = document.getElementById('searchBox').value.trim();
        renderMarkers(filterValue, keywordValue);
    }
}

function renderMarkers(filter='all', keyword=''){
  // å…¨ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
  markerObjs.forEach(o=>map.removeLayer(o));
  markerObjs=[];
  
  places.forEach((s)=>{
    const displayCategory = s.getDisplayCategory();
    
    // **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯**
    if(filter === 'favorite' && !s.isFavorite) return; // ãŠæ°—ã«å…¥ã‚Šãƒ•ã‚£ãƒ«ã‚¿
    if(filter !== 'all' && filter !== 'favorite' && displayCategory !== filter) return; // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿

    if(keyword && !s.name.includes(keyword)) return; // æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿

    const icon=makeDivIcon(displayCategory);
    
    // **ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã«ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã‚’è¿½åŠ **
    const favButtonHTML = s.isFavorite ? 
        `<button id="favBtn-${s.id}" style="background:red;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">â¤ï¸ ãŠæ°—ã«å…¥ã‚Šè§£é™¤</button>` :
        `<button id="favBtn-${s.id}" style="background:gray;color:white;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">ğŸ¤ ãŠæ°—ã«å…¥ã‚Šè¿½åŠ </button>`;

    const popupHTML = `
      <div>
        ${s.img ? `<img src="${s.img}" class="popup-img">` : ""}
        <b>${s.name}</b> (${displayCategory})${s.isFavorite ? '<span class="star-badge" style="top:0; margin-left:8px;">â­ï¸ Faved</span>' : ''}<br>
        <small>${s.info}</small><br><br>
        ${favButtonHTML}
      </div>
    `;
    const marker=L.marker([s.lat,s.lng],{icon}).addTo(map).bindPopup(popupHTML);
    
    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒé–‹ã„ãŸã¨ãã«ãŠæ°—ã«å…¥ã‚Šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    marker.on('popupopen', function() {
        // IDã‚’ä½¿ã£ã¦ç‰¹å®šã®ãƒœã‚¿ãƒ³ã‚’å–å¾—
        const favBtn = document.getElementById(`favBtn-${s.id}`);
        if (favBtn) {
            favBtn.addEventListener('click', () => {
                // åº—èˆ—IDã‚’æ¸¡ã—ã¦çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                toggleFavorite(s.id); 
            });
        }
    });

    markerObjs.push(marker);
  });
}

// ====== ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ ======
document.getElementById('locateBtn').addEventListener('click',()=>{
  if(!navigator.geolocation){alert("ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“");return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    map.setView([latitude,longitude],15);
    L.marker([latitude,longitude]).addTo(map).bindPopup("ğŸ“ ç¾åœ¨åœ°").openPopup();
  },()=>alert("ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"));
});

// ====== ã‚¤ãƒ™ãƒ³ãƒˆ ======
const categoryFilter = document.getElementById('categoryFilter');
const searchBox = document.getElementById('searchBox');

searchBox.addEventListener('input',e=>{
  renderMarkers(categoryFilter.value, e.target.value.trim());
});
categoryFilter.addEventListener('change',e=>{
  renderMarkers(e.target.value, searchBox.value.trim());
});

// ====== åˆæœŸæç”» ======
renderMarkers();
</script>
</body>
</html>
